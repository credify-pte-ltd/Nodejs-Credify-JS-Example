# Credify Integration Sample (Node.js)

:link: [Developers Documentation](https://developers.credify.one/)

This project is an example project of `credify-nodejs`. You can refer a [React Example Project](https://github.com/credify-pte-ltd/React-Credify-JS-Example), too.

Deployed URL: [https://dev-credify-sample.herokuapp.com/](https://dev-credify-sample.herokuapp.com/)

## Endpoints

This project demonstrates 2 roles; data provider and data receiver.

### Data provider

#### `GET: /data-receiver/demo-user`

This returns a random user like following.

```json
{
  "id": 1462,
  "firstName": "Polly",
  "lastName": "Kemmer",
  "email": "Catharine.Dooley88@gmail.com",
  "phoneNumber": "377635294",
  "phoneCountryCode": "+84",
  "creditScore": 338,
  "socialScore": 136,
  "monthlyPaymentAmount": 790414,
  "credifyId": "",
  "createdAt": "2021-02-16T06:03:58.230Z",
  "updatedAt": "2021-02-16T06:03:58.230Z"
}
```

#### `POST: /data-provider/create`

This sets up data provision of a specified user with this data provider's data, BUT the data remains in the data providing service, not in Credify. :closed_lock_with_key:

Request body:

```json
{
  "id": 12,
  "password": "Cred1fy!"  
}
```

Response body:

```json
// ID in Credify system
{
  "id": "011a42b9-62d7-49eb-8328-c2e454af88a1" 
}
```


#### `POST: /data-provider/user-counts`

This returns a total count of eligible users that satisfies a specified criteria.

[Detailed spec is here](https://developers.credify.one/how-to-use-servicex/be-data-provider.html#user-counts-api).

#### `POST: /data-provider/offer-evaluation`

This returns a result of offer evaluation.

[Detailed spec is here](https://developers.credify.one/how-to-use-servicex/be-data-provider.html#offer-evaluation-api).

#### `POST: /data-provider/encrypted-claims`

This encrypts passed claim values with a public key of a data receiver.

[Detailed spec is here](https://developers.credify.one/how-to-use-servicex/be-data-provider.html#encrypted-claims-api).

#### `GET /data-provider/offers-list`

This returns offers list that are available to a specified user.

[Detailed spec is here](https://developers.credify.one/how-to-use-servicex/be-data-provider.html#offers-list-api).

---

### Data receiver

#### `GET: /data-receiver/oidc`

This generates an URL to kick off an OIDC process.

Query parameters:
- `phone_number (string | undefined) (e.g. 843812345678)` 
- `credify_id (string | undefined)`
- `offer_code (string | undefined)`

This redirects the request to OIDC.

[Here is its detail](https://developers.credify.one/how-to-use-servicex/be-data-receiver.html#oidc-setup-url).

#### `POST /data-receiver/oidc`

This handles OIDC callback, receiving `access token` generated by Credify and `state` generated in the initial step.

Request body:

```json
{
  "access_token": "eyj...",
  "state": "xxxxxxxxxx"
}
```

This handles offer redemption or whatever you want with user's data.

## How to run

```shell script
# Clone this projct
$ git clone https://github.com/credify-pte-ltd/credify-nodejs-sample.git

$ cd credify-nodejs-sample

# Install dependencies
$ yarn

# Run a project
$ yarn start
```

Default port is 8000.


## Deployment

This project uses Heroku, and merging to the master branch will kick off the deployment process.

```shell script
# DB migration
$ heroku run yarn db:migrate

# DB seed data removal
$ heroku run yarn db:seed:reset

# DB seed data generation
$ heroku run yarn db:seed:all
```

## Scopes definition

```json
{
   "scopes_definition":[
      {
         "id":"3003a5da-7351-11eb-8347-a6b5174f10ec",
         "provider_id":"37c5abfa-a4b7-4521-a312-89a2ec53e804",
         "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:credit-score",
         "display_name":"Credit score",
         "description":"Credit score derived from user activity in this platform",
         "price":2,
         "is_onetime_charge":false,
         "is_active":true,
         "claims":[
            {
               "id":"3004c939-7351-11eb-8347-a6b5174f10ec",
               "scope_id":"3003a5da-7351-11eb-8347-a6b5174f10ec",
               "main_claim_id":"",
               "scope":null,
               "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:score",
               "display_name":"Credit score value",
               "description":"",
               "value_type":"Integer",
               "min_value":0,
               "max_value":500,
               "is_active":false,
               "created_at":"2021-02-20T07:56:50.009748Z",
               "updated_at":"2021-02-20T07:56:50.009749Z",
               "nested":null
            },
            {
               "id":"30060baa-7351-11eb-8347-a6b5174f10ec",
               "scope_id":"3003a5da-7351-11eb-8347-a6b5174f10ec",
               "main_claim_id":"",
               "scope":null,
               "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:fraud",
               "display_name":"Fraud or not",
               "description":"",
               "value_type":"Boolean",
               "min_value":null,
               "max_value":null,
               "is_active":false,
               "created_at":"2021-02-20T07:56:50.018005Z",
               "updated_at":"2021-02-20T07:56:50.018005Z",
               "nested":null
            },
            {
               "id":"30070f96-7351-11eb-8347-a6b5174f10ec",
               "scope_id":"3003a5da-7351-11eb-8347-a6b5174f10ec",
               "main_claim_id":"",
               "scope":null,
               "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:updated-at",
               "display_name":"Updated at",
               "description":"",
               "value_type":"Text",
               "min_value":null,
               "max_value":null,
               "is_active":false,
               "created_at":"2021-02-20T07:56:50.024668Z",
               "updated_at":"2021-02-20T07:56:50.024668Z",
               "nested":null
            }
         ],
         "created_at":"2021-02-20T07:56:50.002719Z",
         "updated_at":"2021-02-20T07:56:50.002719Z",
         "unit":"USD",
         "provider":null
      },
      {
         "id":"30081f6e-7351-11eb-8347-a6b5174f10ec",
         "provider_id":"37c5abfa-a4b7-4521-a312-89a2ec53e804",
         "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:transactions",
         "display_name":"Transaction data",
         "description":"User transation data",
         "price":3,
         "is_onetime_charge":false,
         "is_active":true,
         "claims":[
            {
               "id":"300955ab-7351-11eb-8347-a6b5174f10ec",
               "scope_id":"30081f6e-7351-11eb-8347-a6b5174f10ec",
               "main_claim_id":"",
               "scope":null,
               "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:total-count",
               "display_name":"Transaction count",
               "description":"",
               "value_type":"Integer",
               "min_value":0,
               "max_value":1000,
               "is_active":false,
               "created_at":"2021-02-20T07:56:50.039579Z",
               "updated_at":"2021-02-20T07:56:50.039579Z",
               "nested":null
            },
            {
               "id":"300a5f3b-7351-11eb-8347-a6b5174f10ec",
               "scope_id":"30081f6e-7351-11eb-8347-a6b5174f10ec",
               "main_claim_id":"",
               "scope":null,
               "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:monthly-payment-amount",
               "display_name":"Monthly payment amount",
               "description":"",
               "value_type":"Integer",
               "min_value":0,
               "max_value":1000000,
               "is_active":false,
               "created_at":"2021-02-20T07:56:50.046359Z",
               "updated_at":"2021-02-20T07:56:50.046359Z",
               "nested":null
            },
            {
               "id":"300b794b-7351-11eb-8347-a6b5174f10ec",
               "scope_id":"30081f6e-7351-11eb-8347-a6b5174f10ec",
               "main_claim_id":"",
               "scope":null,
               "name":"37c5abfa-a4b7-4521-a312-89a2ec53e804:currency",
               "display_name":"Currency",
               "description":"",
               "value_type":"Text",
               "min_value":null,
               "max_value":null,
               "is_active":false,
               "created_at":"2021-02-20T07:56:50.053583Z",
               "updated_at":"2021-02-20T07:56:50.053583Z",
               "nested":null
            }
         ],
         "created_at":"2021-02-20T07:56:50.031624Z",
         "updated_at":"2021-02-20T07:56:50.031624Z",
         "unit":"USD",
         "provider":null
      }
   ]
}
```
